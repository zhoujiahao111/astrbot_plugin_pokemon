# coding=utf-8
import asyncio
import math
from concurrent.futures import ThreadPoolExecutor
import astrbot.api.event.filter as filter
from astrbot.api.all import AstrMessageEvent, MessageChain, Image, Plain, Node, Reply, At, Nodes
from astrbot.api.star import Context, Star, register

import inspect
from functools import wraps
import time

from .core import json_manager
from .utils import image_utils, text_utils, validators
from .repository import pokemon_repository, battle_repository, team_repository, item_repository, user_repository
from .game import bag, battle
from .services import player_services, bag_services, image_data_services, pokemon_services, team_services, \
    battle_services
from .models.session import ä¼šè¯ç±»
from .models.enums import é¢†å…»é˜¶æ®µç±», ç¼“å­˜ç±»å‹ç±»

def æ£€æŸ¥ç”¨æˆ·æ³¨å†ŒçŠ¶æ€(func):
    @wraps(func)
    async def wrapper(self, äº‹ä»¶: AstrMessageEvent, *args, **kwargs):

        ç”¨æˆ·qq = validators.éªŒè¯ç”¨æˆ·qqæ–¹æ³•(äº‹ä»¶.get_sender_id())
        ç»“æœ = await player_services.åˆ¤æ–­ç”¨æˆ·æ˜¯å¦æ³¨å†Œæ–¹æ³•(ç”¨æˆ·qq=ç”¨æˆ·qq)

        if not ç»“æœ.æ•°æ®ä¿¡æ¯:
            yield äº‹ä»¶.plain_result("æ‚¨è¿˜æ²¡æœ‰è·å–ç¬¬ä¸€åªå®å¯æ¢¦ä¼™ä¼´å“¦\nä½¿ç”¨ã€Œ/pm é¢†å…»ã€å³å¯")
            return

        # è°ƒç”¨åŸå§‹å‡½æ•°ï¼Œä½†å…ˆä¸ awaitï¼Œä»¥è·å–å…¶è¿”å›çš„åç¨‹æˆ–å¼‚æ­¥ç”Ÿæˆå™¨å¯¹è±¡
        ç›®æ ‡å¯¹è±¡ = func(self, äº‹ä»¶, *args, **kwargs)

        # æ£€æŸ¥è¿”å›çš„æ˜¯å¦ä¸ºå¼‚æ­¥ç”Ÿæˆå™¨
        if inspect.isasyncgen(ç›®æ ‡å¯¹è±¡):
            # å¦‚æœæ˜¯å¼‚æ­¥ç”Ÿæˆå™¨ï¼Œä½¿ç”¨ async for è¿­ä»£å¹¶é€ä¸ª yield å…¶äº§ç”Ÿçš„å€¼
            async for item in ç›®æ ‡å¯¹è±¡:
                yield item
        else:
            ç»“æœ = await ç›®æ ‡å¯¹è±¡
            if ç»“æœ is not None:
                yield ç»“æœ

    return wrapper


def ä¼šè¯åˆå§‹åŒ–(å‡½æ•°):
    @wraps(å‡½æ•°)
    async def åˆå§‹åŒ–(self, äº‹ä»¶: AstrMessageEvent, *args, **kwargs):
        ä¼šè¯ = ä¼šè¯ç±»(
            jsonç®¡ç†å™¨=self.jsonç®¡ç†å™¨,
            é…ç½®=self.é…ç½®,
            äº‹ä»¶=äº‹ä»¶
        )
        äº‹ä»¶.ä¼šè¯ = ä¼šè¯

        async for item in å‡½æ•°(self, äº‹ä»¶, *args, **kwargs):
            yield item

    return åˆå§‹åŒ–


@register("astrbot_plugin_pokemon", "å‘¨ä½³è±ª", "å®å¯æ¢¦æ’ä»¶, æ–‡å­—ç‰ˆå®å¯æ¢¦æ¸¸æˆ", "1.0.0",
          "https://www.bilibili.com/video/BV16p4y1w7U3/")
class å®å¯æ¢¦æ’ä»¶ç±»(Star):
    def __init__(self, context: Context, config: dict):
        super().__init__(context)
        self.é€šç”¨æ“ä½œç¼“å­˜: dict = {}
        self.é€šç”¨æ“ä½œç¼“å­˜_é” = asyncio.Lock()

        self.çº¿ç¨‹æ±  = ThreadPoolExecutor()

        self.jsonç®¡ç†å™¨ = json_manager.jsonç®¡ç†å™¨()

        self.é…ç½® = config

        self.ç¼“å­˜è¶…æ—¶æ—¶é•¿ = config.get("cache_max_timeout", 120)

        asyncio.create_task(self._æ¸…ç†ç¼“å­˜æ–¹æ³•())
        

    async def _æ¸…ç†ç¼“å­˜æ–¹æ³•(self):
        """
        å®šæ—¶æ¸…ç†æ‰€æœ‰ç”¨æˆ·çš„è¿‡æœŸç¼“å­˜é¡¹ã€‚
        """
        while True:
            await asyncio.sleep(self.ç¼“å­˜è¶…æ—¶æ—¶é•¿)

            å½“å‰æ—¶é—´ = time.time()
            å¾…å¤„ç†çš„è¿‡æœŸé¡¹ = []

            async with self.é€šç”¨æ“ä½œç¼“å­˜_é”:
                ç©ºçš„qqé”®åˆ—è¡¨ = []
                # éå†æ¯ä¸ªç”¨æˆ·
                for qq, ç”¨æˆ·æ“ä½œé›† in self.é€šç”¨æ“ä½œç¼“å­˜.items():
                    # æ‰¾åˆ°è¯¥ç”¨æˆ·æ‰€æœ‰å·²è¿‡æœŸçš„æ“ä½œç±»å‹

                    è¿‡æœŸçš„æ“ä½œç±»å‹åˆ—è¡¨ = [
                        æ“ä½œç±»å‹ for æ“ä½œç±»å‹, ä¿¡æ¯ in ç”¨æˆ·æ“ä½œé›†.items()
                        if ä¿¡æ¯["åˆ°æœŸæ—¶é—´"] < å½“å‰æ—¶é—´
                    ]

                    # ç§»é™¤è¿‡æœŸçš„æ“ä½œ
                    for æ“ä½œç±»å‹ in è¿‡æœŸçš„æ“ä½œç±»å‹åˆ—è¡¨:
                        ä¿¡æ¯ = ç”¨æˆ·æ“ä½œé›†.pop(æ“ä½œç±»å‹)
                        å¾…å¤„ç†çš„è¿‡æœŸé¡¹.append((ä¿¡æ¯["äº‹ä»¶"], æ“ä½œç±»å‹, qq))

                    # å¦‚æœä¸€ä¸ªç”¨æˆ·çš„æ‰€æœ‰æ“ä½œéƒ½å·²è¿‡æœŸå¹¶è¢«ç§»é™¤ï¼Œåˆ™æ ‡è®°è¿™ä¸ªç”¨æˆ·ä»¥ä¾¿ä»é¡¶å±‚ç¼“å­˜ä¸­åˆ é™¤
                    if not ç”¨æˆ·æ“ä½œé›†:
                        ç©ºçš„qqé”®åˆ—è¡¨.append(qq)

                # æ¸…ç†æ²¡æœ‰ä»»ä½•å¾…å¤„ç†æ“ä½œçš„ç”¨æˆ·
                for qq in ç©ºçš„qqé”®åˆ—è¡¨:
                    del self.é€šç”¨æ“ä½œç¼“å­˜[qq]

            # åœ¨é”ä¹‹å¤–å¤„ç†ç½‘ç»œIOï¼Œé¿å…é•¿æ—¶é—´é˜»å¡
            for äº‹ä»¶, æ¶ˆæ¯ç±»å‹, qq in å¾…å¤„ç†çš„è¿‡æœŸé¡¹:
                try:
                    if æ¶ˆæ¯ç±»å‹ is ç¼“å­˜ç±»å‹ç±».é¢†å…»å®å¯æ¢¦:
                        è¾“å‡º = "æ—¶é—´è¿‡å»å¤ªä¹…äº†, è¯·é‡æ–°ä½¿ç”¨ã€Œ/pm é¢†å…»ã€ æ¥è·å–å¿ƒä»ªçš„ä¼™ä¼´å§ã€‚"
                    elif æ¶ˆæ¯ç±»å‹ is ç¼“å­˜ç±»å‹ç±».åˆ é™¤é˜Ÿä¼:
                        è¾“å‡º = "åˆ é™¤é˜Ÿä¼çš„ç¡®è®¤å·²è¶…æ—¶ï¼Œæ“ä½œå·²å–æ¶ˆã€‚"
                    else:
                        è¾“å‡º = "æ²¡ä»€ä¹ˆäº‹æƒ…, åªæ˜¯ç¨‹åºå¯èƒ½å‡ºé”™äº†, è®°å½•äº†ä¸å­˜åœ¨çš„æ“ä½œç±»å‹"

                    await äº‹ä»¶.send(
                        äº‹ä»¶.chain_result([
                            At(qq=qq),
                            Plain(è¾“å‡º)
                        ]))

                except Exception as e:
                    print(f"å¤„ç†è¿‡æœŸé¡¹æ—¶å‘ç”Ÿé”™è¯¯: {e}")

    @filter.command_group("pm")
    async def pm(self, event: AstrMessageEvent):
        yield event.plain_result(f"æŒ‡ä»¤å­˜åœ¨ã€‚")
        return



    @pm.command("é¢†å…»", alias={"é¢†å…»", "è·å–", "é¢†å…»å®å¯æ¢¦"})
    @ä¼šè¯åˆå§‹åŒ–
    async def é¢†å…»å®å¯æ¢¦æ–¹æ³•(self, äº‹ä»¶: AstrMessageEvent, é€‰æ‹©: str = None):
        """æ¥é¢†å…»ä¸€åªå®å¯æ¢¦å§ã€‚"""
        ä¼šè¯: ä¼šè¯ç±» = äº‹ä»¶.ä¼šè¯

        æ³¨å†Œç»“æœ = await player_services.åˆ¤æ–­ç”¨æˆ·æ˜¯å¦æ³¨å†Œæ–¹æ³•(ä¼šè¯.ç”¨æˆ·qq)

        if æ³¨å†Œç»“æœ.æ•°æ®ä¿¡æ¯:
            å®å¯æ¢¦æ€»æ•° = await user_repository.è·å–ç”¨æˆ·å®å¯æ¢¦æ€»æ•°æ–¹æ³•(ä¼šè¯)

            if å®å¯æ¢¦æ€»æ•° > 0:
                yield äº‹ä»¶.plain_result("å“å‘€~ è®­ç»ƒå®¶å·²ç»é¢†å–è¿‡åˆå§‹å®å¯æ¢¦äº†å‘¢ï¼ä½¿ç”¨ ã€Œ/pm é˜Ÿä¼ã€å¯ä»¥æŸ¥çœ‹å®å¯æ¢¦å“¦")
                return
            elif å®å¯æ¢¦æ€»æ•° == -1:
                yield äº‹ä»¶.plain_result("å¥‡æ€ª, è·å–ä½ çš„å®å¯æ¢¦æ€»æ•°æ—¶å‡ºç°äº†é‡å¤§é”™è¯¯")
                return

        async with self.é€šç”¨æ“ä½œç¼“å­˜_é”:
            ç¼“å­˜ä¿¡æ¯: dict = self.é€šç”¨æ“ä½œç¼“å­˜.get(ä¼šè¯.ç”¨æˆ·qq, {}).get(ç¼“å­˜ç±»å‹ç±».é¢†å…»å®å¯æ¢¦, {})
            å½“å‰é˜¶æ®µ = ç¼“å­˜ä¿¡æ¯.get("é˜¶æ®µ", é¢†å…»é˜¶æ®µç±».é¦–æ¬¡æ‰§è¡Œ)
            å­˜å‚¨æ•°æ® = ç¼“å­˜ä¿¡æ¯.get("æ•°æ®", None)
            å·²è­¦å‘Š = ç¼“å­˜ä¿¡æ¯.get("å·²è­¦å‘Š", False)

            if é€‰æ‹© is None and å½“å‰é˜¶æ®µ != é¢†å…»é˜¶æ®µç±».é¦–æ¬¡æ‰§è¡Œ and å·²è­¦å‘Š == False:
                ç¼“å­˜ä¿¡æ¯["å·²è­¦å‘Š"] = True
                if ä¼šè¯.ç”¨æˆ·qq not in self.é€šç”¨æ“ä½œç¼“å­˜:
                    self.é€šç”¨æ“ä½œç¼“å­˜[ä¼šè¯.ç”¨æˆ·qq] = {}
                self.é€šç”¨æ“ä½œç¼“å­˜[ä¼šè¯.ç”¨æˆ·qq][ç¼“å­˜ç±»å‹ç±».é¢†å…»å®å¯æ¢¦] = ç¼“å­˜ä¿¡æ¯

                yield äº‹ä»¶.plain_result("å†æ¬¡è¾“å…¥ã€Œ/pm é¢†å…»ã€å°†ä¼šé‡æ–°å¼€å§‹é€‰æ‹©")
                return

            # åˆ¤æ–­å¹¶æ‰§è¡ŒçŠ¶æ€æœºé˜¶æ®µè¿”å›ä»»åŠ¡
            elif é€‰æ‹© == "è¿”å›":
                if å½“å‰é˜¶æ®µ is é¢†å…»é˜¶æ®µç±».é¦–æ¬¡æ‰§è¡Œ or å½“å‰é˜¶æ®µ is é¢†å…»é˜¶æ®µç±».å·²æŸ¥çœ‹ç»„åˆ:
                    yield äº‹ä»¶.plain_result("å½“å‰é˜¶æ®µæ— éœ€è¿”å›å“¦, è¯·è¾“å…¥ã€Œ/pm é¢†å…»ã€æ¥æŸ¥çœ‹ç»„åˆä¿¡æ¯")

                elif å½“å‰é˜¶æ®µ is é¢†å…»é˜¶æ®µç±».å·²æŸ¥çœ‹å®å¯æ¢¦ä¿¡æ¯:
                    self.é€šç”¨æ“ä½œç¼“å­˜[ä¼šè¯.ç”¨æˆ·qq] = {
                        ç¼“å­˜ç±»å‹ç±».é¢†å…»å®å¯æ¢¦: {
                            "åˆ°æœŸæ—¶é—´": time.time() + self.ç¼“å­˜è¶…æ—¶æ—¶é•¿,
                            "é˜¶æ®µ": é¢†å…»é˜¶æ®µç±».å·²æŸ¥çœ‹ç»„åˆ,
                            "äº‹ä»¶": äº‹ä»¶
                        }
                    }
                    yield äº‹ä»¶.plain_result("æˆåŠŸè¿”å›è‡³æŸ¥çœ‹ç»„åˆä¿¡æ¯é˜¶æ®µ, è¯·ä½¿ç”¨ã€Œ/pm é¢†å…» ç»„åˆåç§°æˆ–åºå·ã€")
                else:
                    yield äº‹ä»¶.plain_result("å½“å‰å¤„äºæœªçŸ¥é˜¶æ®µ, æ— æ³•è¿”å›, å»ºè®®ä½¿ç”¨ä¸¤æ¬¡ã€Œ/pm é¢†å…»ã€æ¥é‡ç½®")

                return

                # ç¼“å­˜æ— è®°å½• æˆ–è€… å·²ç»è­¦å‘Šçš„æƒ…å†µä¸‹ç»§ç»­ä¸æºå¸¦å‚æ•°
            elif å½“å‰é˜¶æ®µ is é¢†å…»é˜¶æ®µç±».é¦–æ¬¡æ‰§è¡Œ or (å·²è­¦å‘Š and é€‰æ‹© is None):
                yield äº‹ä»¶.plain_result(
                    player_services.è¾“å‡ºåˆå§‹ä¼™ä¼´ç»„åˆä¿¡æ¯æ–¹æ³•(ä¼šè¯.jsonç®¡ç†å™¨.åˆå§‹ä¼™ä¼´)
                )

                self.é€šç”¨æ“ä½œç¼“å­˜[ä¼šè¯.ç”¨æˆ·qq] = {
                    ç¼“å­˜ç±»å‹ç±».é¢†å…»å®å¯æ¢¦: {
                        "åˆ°æœŸæ—¶é—´": time.time() + self.ç¼“å­˜è¶…æ—¶æ—¶é•¿,
                        "é˜¶æ®µ": é¢†å…»é˜¶æ®µç±».å·²æŸ¥çœ‹ç»„åˆ,
                        "äº‹ä»¶": äº‹ä»¶
                    }
                }

                return

            # ç¬¬ä¸€æ¬¡æŸ¥çœ‹ç»„åˆä¿¡æ¯, æˆ–è€…æŸ¥çœ‹è¿‡å®å¯æ¢¦è¯¦æƒ…, è¿˜è¾“å…¥äº†é¡µæ•°æ§åˆ¶å‚æ•°
            elif å½“å‰é˜¶æ®µ is é¢†å…»é˜¶æ®µç±».å·²æŸ¥çœ‹ç»„åˆ or (
                å½“å‰é˜¶æ®µ == é¢†å…»é˜¶æ®µç±».å·²æŸ¥çœ‹å®å¯æ¢¦ä¿¡æ¯ and
                é€‰æ‹© in ["ä¸Šä¸€é¡µ", "ä¸‹ä¸€é¡µ"]
            ):
                è¾“å‡ºå†…å®¹, é€‰æ‹©çš„åç§°, æ˜¯å¦æˆåŠŸ, æ–°é¡µæ•° = player_services.è¾“å‡ºä¼™ä¼´ç»„åˆè¯¦ç»†ä¿¡æ¯æ–¹æ³•(
                    ä¼šè¯.jsonç®¡ç†å™¨.åˆå§‹ä¼™ä¼´,
                    ä¼šè¯.jsonç®¡ç†å™¨.å®å¯æ¢¦å›¾é‰´,
                    é€‰æ‹©,
                    å­˜å‚¨æ•°æ®
                )

                if æ˜¯å¦æˆåŠŸ:
                    self.é€šç”¨æ“ä½œç¼“å­˜[ä¼šè¯.ç”¨æˆ·qq] = {
                        ç¼“å­˜ç±»å‹ç±».é¢†å…»å®å¯æ¢¦: {
                            "åˆ°æœŸæ—¶é—´": time.time() + self.ç¼“å­˜è¶…æ—¶æ—¶é•¿,
                            "é˜¶æ®µ": é¢†å…»é˜¶æ®µç±».å·²æŸ¥çœ‹å®å¯æ¢¦ä¿¡æ¯,
                            "æ•°æ®": é€‰æ‹©çš„åç§°,
                            "é¡µæ•°": æ–°é¡µæ•°,
                            "äº‹ä»¶": äº‹ä»¶
                        }
                    }

                    èŠ‚ç‚¹åˆ—è¡¨ = []
                    for item in è¾“å‡ºå†…å®¹:
                        if isinstance(item, str):
                            èŠ‚ç‚¹åˆ—è¡¨.append(
                                Node(
                                    uin=ä¼šè¯.æœºå™¨äººqq,
                                    content=[Plain(item)]
                                )
                            )
                        elif isinstance(item, tuple) and len(item) == 3:
                            è´´å›¾æ•°æ®, åºå·, ç®€ä»‹ = item
                            # æŠŠå›¾ç‰‡å’Œæ–‡å­—ä¸€æ¬¡æ€§å¡åˆ°åŒä¸€ä¸ª Node é‡Œ
                            èŠ‚ç‚¹åˆ—è¡¨.append(
                                Node(
                                    uin=ä¼šè¯.æœºå™¨äººqq,
                                    content=[
                                        Image.fromBytes(è´´å›¾æ•°æ®),  # å›¾ç‰‡
                                        Plain(f"#{åºå·} {ç®€ä»‹}")
                                    ]
                                )
                            )
                        else:
                            # ä¾‹å¤–çš„ç‰¹æ®Šæƒ…å†µ, åº”è¯¥ä¸ä¼šæ‰§è¡Œå§
                            èŠ‚ç‚¹åˆ—è¡¨.append(
                                Node(
                                    uin=ä¼šè¯.æœºå™¨äººqq,
                                    content=[Plain(str(item))]
                                )
                            )

                    yield äº‹ä»¶.chain_result([Nodes(nodes=èŠ‚ç‚¹åˆ—è¡¨)])
                else:
                    # å†…å®¹ä¸ºstræ ¼å¼çš„æŠ¥é”™ä¿¡æ¯
                    yield äº‹ä»¶.plain_result(è¾“å‡ºå†…å®¹)
                return

            elif å½“å‰é˜¶æ®µ == é¢†å…»é˜¶æ®µç±».å·²æŸ¥çœ‹å®å¯æ¢¦ä¿¡æ¯:
                è¾“å‡ºä¿¡æ¯, æ˜¯å¦æˆåŠŸ = await player_services.æ‰§è¡Œç”¨æˆ·æ³¨å†Œæ–¹æ³•(
                    ä¼šè¯=ä¼šè¯,
                    é€‰æ‹©=é€‰æ‹©,
                    å­˜å‚¨æ•°æ®=å­˜å‚¨æ•°æ®,
                    æ˜¯å¦æ–°ç”¨æˆ·=False if æ³¨å†Œç»“æœ.æ•°æ®ä¿¡æ¯ else True
                )

                if æ˜¯å¦æˆåŠŸ:
                    self.é€šç”¨æ“ä½œç¼“å­˜.pop(ä¼šè¯.ç”¨æˆ·qq, None)
                yield äº‹ä»¶.plain_result(è¾“å‡ºä¿¡æ¯)
            else:
                yield äº‹ä»¶.plain_result("å¥‡æ€ª, çœ‹ä¸Šå»å‡ºç°äº†æ¯”è¾ƒä¸¥é‡çš„é”™è¯¯, å»ºè®®è”ç³»æœºå™¨äººçš„ç®¡ç†å‘˜")

    @filter.permission_type(filter.PermissionType.ADMIN)
    @pm.command("å¼ºåˆ¶æ”¹å", alias={"å®å¯æ¢¦å¼ºåˆ¶é‡å‘½å", "å®å¯æ¢¦å¼ºåˆ¶ä¿®æ”¹åå­—"})
    @ä¼šè¯åˆå§‹åŒ–
    async def å®å¯æ¢¦å¼ºåˆ¶æ”¹åæ–¹æ³•(self, äº‹ä»¶: AstrMessageEvent, ä¸»é”®ID: int, æ–°åç§°: str):
        """ä»…é™ç®¡ç†å‘˜ ä¸»é”®IDæ˜¯ä¼šè¯.ç”¨æˆ·qqå· åç§°æ— å®¡æ ¸"""
        ä¼šè¯: ä¼šè¯ç±» = äº‹ä»¶.ä¼šè¯
        ç»“æœ = await pokemon_repository.æ‰§è¡Œå®å¯æ¢¦æ”¹åæ–¹æ³•(
            ä¼šè¯=ä¼šè¯,
            æ–°åç§°=æ–°åç§°,
            ä¸»é”®ID=ä¸»é”®ID,
            æ˜¯å¦æ£€æµ‹è¿ç¦è¯=False
        )

        yield äº‹ä»¶.plain_result(ç»“æœ.æ•°æ®ä¿¡æ¯ if ç»“æœ.æ˜¯å¦æˆåŠŸ else ç»“æœ.é”™è¯¯ä¿¡æ¯)

    @filter.permission_type(filter.PermissionType.ADMIN)
    @pm.command("å¼ºåˆ¶æ·»åŠ å®å¯æ¢¦", alias={"å®å¯æ¢¦å¼ºåˆ¶æ·»åŠ ", "å®å¯æ¢¦æ·»åŠ ", "æ·»åŠ å®å¯æ¢¦"})
    @ä¼šè¯åˆå§‹åŒ–
    async def å¼ºåˆ¶æ·»åŠ å®å¯æ¢¦æ–¹æ³•(self, äº‹ä»¶: AstrMessageEvent, ç”¨æˆ·ID: int, ç¼–å·: str):
        """ä»…é™ç®¡ç†å‘˜ ç¼–å·æ˜¯å®å¯æ¢¦å›¾é‰´çš„ç¼–å·,å¹¶éç´¢å¼•"""
        ä¼šè¯: ä¼šè¯ç±» = äº‹ä»¶.ä¼šè¯

        if not all([ç”¨æˆ·ID, ç¼–å·]):
            yield äº‹ä»¶.plain_result(
                f"ç®¡ç†å‘˜å¤§äºº, å¡«å†™çš„å‚æ•°ä¸å…¨å“¦, éœ€è¦è¾“å…¥[ç”¨æˆ·ID å®å¯æ¢¦ç¼–å·(éç´¢å¼•) é˜Ÿä¼ID é˜Ÿä¼ä½ç½®(0å¼€å§‹,æœ€å¤§ä¸º5)]\nä¸æ·»åŠ é˜Ÿä¼å’Œé˜Ÿä¼ä½ç½®æ—¶, "
                f"é»˜è®¤æ”¾å…¥ç›’å­å“¦\nä½¿ç”¨ç©ºæ ¼é—´éš”å‚æ•°, å¦å¤–è¯·è°¨æ…ä½¿ç”¨"
            )
            return

        ç»“æœ = pokemon_services.å®å¯æ¢¦ç”Ÿæˆæ–¹æ³•(ä¼šè¯=ä¼šè¯, ç¼–å·=ç¼–å·)

        if ç»“æœ.æ˜¯å¦æˆåŠŸ:
            å®å¯æ¢¦æ•°æ®: dict = ç»“æœ.æ•°æ®ä¿¡æ¯
        else:
            print(f"å®å¯æ¢¦ç”Ÿæˆå¤±è´¥ " + ç»“æœ.é”™è¯¯ä¿¡æ¯)
            yield äº‹ä»¶.plain_result("ç®¡ç†å‘˜å¤§äºº, å®å¯æ¢¦ç”Ÿæˆå¤±è´¥äº†")
            return

        å®å¯æ¢¦æ•°æ®["ç”¨æˆ·ID"] = ç”¨æˆ·ID

        ç»“æœ = await pokemon_services.å®å¯æ¢¦æ·»åŠ æ–¹æ³•(
            ç”¨æˆ·ID=ç”¨æˆ·ID,
            å®å¯æ¢¦æ•°æ®=å®å¯æ¢¦æ•°æ®
        )

        if ç»“æœ.æ˜¯å¦æˆåŠŸ:
            yield äº‹ä»¶.plain_result(
                f"ç®¡ç†å‘˜å¤§äºº, å·²æˆåŠŸä¸ºç”¨æˆ·{ç”¨æˆ·ID} æ·»åŠ {å®å¯æ¢¦æ•°æ®['æ˜µç§°']}")
        else:
            yield äº‹ä»¶.plain_result(ç»“æœ.é”™è¯¯ä¿¡æ¯)

        return

    @pm.command("æ”¹å", alias={"æ”¹åå®å¯æ¢¦", "å®å¯æ¢¦é‡å‘½å", "å®å¯æ¢¦ä¿®æ”¹åå­—"})
    @æ£€æŸ¥ç”¨æˆ·æ³¨å†ŒçŠ¶æ€
    @ä¼šè¯åˆå§‹åŒ–
    async def å®å¯æ¢¦æ”¹åæ–¹æ³•(self, äº‹ä»¶: AstrMessageEvent, ä½ç½®åºå·: int, æ–°åç§°: str):
        """ä½ç½®åºå·æ˜¯å®å¯æ¢¦åœ¨é˜Ÿå†…çš„ä½ç½®å“¦,ä»1å¼€å§‹, åç§°é•¿åº¦1åˆ°10å­—"""
        ä¼šè¯: ä¼šè¯ç±» = äº‹ä»¶.ä¼šè¯

        ç»“æœ = await pokemon_repository.æ‰§è¡Œå®å¯æ¢¦æ”¹åæ–¹æ³•(
            ä¼šè¯=ä¼šè¯,
            æ–°åç§°=æ–°åç§°,
            ä½ç½®åºå·=ä½ç½®åºå·,
            æ˜¯å¦æ£€æµ‹è¿ç¦è¯=True
        )

        yield äº‹ä»¶.plain_result(ç»“æœ.æ•°æ®ä¿¡æ¯ if ç»“æœ.æ˜¯å¦æˆåŠŸ else ç»“æœ.é”™è¯¯ä¿¡æ¯)

    @pm.command("å•†åº—", alias={"shop", "æŸ¥çœ‹å•†åº—", "å®å¯æ¢¦å•†åº—"})
    @æ£€æŸ¥ç”¨æˆ·æ³¨å†ŒçŠ¶æ€
    @ä¼šè¯åˆå§‹åŒ–
    async def æŸ¥çœ‹å•†åº—æ–¹æ³•(self, äº‹ä»¶: AstrMessageEvent, é¡µæ•°: int = 1):
        èŠ‚ç‚¹åˆ—è¡¨ = []
        ä¼šè¯: ä¼šè¯ç±» = äº‹ä»¶.ä¼šè¯

        æ‰€æœ‰é“å…· = ä¼šè¯.jsonç®¡ç†å™¨.é“å…·.è·å–æ‰€æœ‰ç‰©å“()
        é“å…·æ€»æ•° = len(æ‰€æœ‰é“å…·)
        å•é¡µæ•°é‡ = ä¼šè¯.å•†åº—èŠå¤©è®°å½•å•†å“æ•°é‡

        if é“å…·æ€»æ•° == 0:
            yield äº‹ä»¶.plain_result("å•†åº—é‡Œè¿˜æ²¡æœ‰ä»»ä½•å•†å“å“¦ï¼")
            return

        # ç¡®ä¿å•é¡µæ•°é‡å¤§äº0ï¼Œé¿å…é™¤é›¶é”™è¯¯
        if å•é¡µæ•°é‡ <= 0:
            yield äº‹ä»¶.plain_result("é”™è¯¯ï¼šå•†åº—é…ç½®çš„å•é¡µå•†å“æ•°é‡æ— æ•ˆï¼Œè¯·è”ç³»ç®¡ç†å‘˜ã€‚")
            return

        æ€»é¡µæ•° = math.ceil(é“å…·æ€»æ•° / å•é¡µæ•°é‡)

        if not (1 <= é¡µæ•° <= æ€»é¡µæ•°):
            yield äº‹ä»¶.plain_result(f"é¡µæ•°æ— æ•ˆï¼å½“å‰å•†åº—å…±æœ‰ {æ€»é¡µæ•°} é¡µï¼Œè¯·è¾“å…¥ 1 åˆ° {æ€»é¡µæ•°} ä¹‹é—´çš„é¡µç ã€‚")
            return

        # è®¡ç®—å½“å‰é¡µçš„é“å…·èµ·å§‹å’Œç»“æŸç´¢å¼•
        èµ·å§‹ç´¢å¼• = (é¡µæ•° - 1) * å•é¡µæ•°é‡
        ç»“æŸç´¢å¼• = èµ·å§‹ç´¢å¼• + å•é¡µæ•°é‡
        æœ¬é¡µé“å…·åˆ—è¡¨ = æ‰€æœ‰é“å…·[èµ·å§‹ç´¢å¼•:ç»“æŸç´¢å¼•]

        # åœ¨åˆ—è¡¨æœ€å‰é¢æ·»åŠ é¡µæ•°å’Œç¿»é¡µæç¤º
        é¡µçœ‰æ–‡æœ¬ = f"å½“å‰æ˜¯ç¬¬ {é¡µæ•°}/{æ€»é¡µæ•°} é¡µ\n"
        é¡µçœ‰æ–‡æœ¬ += f"ä½¿ç”¨ /pm å•†åº— <é¡µæ•°> å¯è·³è½¬é¡µé¢\n"
        é¡µçœ‰æ–‡æœ¬ += "--------------------\n"

        is_first_item = True

        for é“å…·ä¿¡æ¯ in æœ¬é¡µé“å…·åˆ—è¡¨:
            ç»“æœ = image_utils.è¯»å–å›¾ç‰‡æ–¹æ³•(ç±»åˆ«="goods", åç§°=é“å…·ä¿¡æ¯.è´´å›¾, æ˜¯å¦è½¬ä¸ºjpg=True)

            if not ç»“æœ.æ˜¯å¦æˆåŠŸ:
                print(f"{é“å…·ä¿¡æ¯.åç§°}çš„è´´å›¾è¯»å–å¤±è´¥: {ç»“æœ.é”™è¯¯ä¿¡æ¯}")
                yield äº‹ä»¶.plain_result(f"ç³Ÿç³•, {é“å…·ä¿¡æ¯.åç§°}çš„å›¾ç‰‡ä¼¼ä¹æŸåäº†, è¯·è”ç³»ç®¡ç†å‘˜ä¿®å¤ã€‚")
                # å•ä¸ªå•†å“é”™è¯¯
                return

            è´´å›¾æ•°æ®: bytes = ç»“æœ.æ•°æ®ä¿¡æ¯
            å•†å“è¯¦æƒ… = f"åç§°: {é“å…·ä¿¡æ¯.åç§°}\nğŸ’°ï¸: {é“å…·ä¿¡æ¯.ä»·æ ¼}å…ƒ\næè¿°: {é“å…·ä¿¡æ¯.æè¿°}\n\n\n"

            content_list = []
            if is_first_item:
                content_list.append(Plain(é¡µçœ‰æ–‡æœ¬))
                is_first_item = False

            content_list.extend([
                Image.fromBytes(è´´å›¾æ•°æ®),
                Plain(å•†å“è¯¦æƒ…)
            ])

            èŠ‚ç‚¹åˆ—è¡¨.append(
                Node(
                    uin=ä¼šè¯.æœºå™¨äººqq,
                    content=content_list
                )
            )

        if èŠ‚ç‚¹åˆ—è¡¨:
            yield äº‹ä»¶.chain_result([Nodes(nodes=èŠ‚ç‚¹åˆ—è¡¨)])
        else:
            yield äº‹ä»¶.plain_result(f"æœªèƒ½è·å–ç¬¬ {é¡µæ•°} é¡µçš„å•†å“åˆ—è¡¨ï¼Œå»ºè®®è”ç³»ç®¡ç†å‘˜ã€‚")

    @pm.command("è´­ä¹°", alias={"buy", "è´­ä¹°å•†å“", "è´­ä¹°ç‰©å“"})
    @æ£€æŸ¥ç”¨æˆ·æ³¨å†ŒçŠ¶æ€
    @ä¼šè¯åˆå§‹åŒ–
    async def å•†å“è´­ä¹°æ–¹æ³•(self, äº‹ä»¶: AstrMessageEvent, åç§°: str, æ•°é‡: int = 1):
        """å»ºè®®å…ˆä½¿ç”¨ã€Œ/pm å•†åº—ã€æŸ¥çœ‹å•†å“"""
        ä¼šè¯: ä¼šè¯ç±» = äº‹ä»¶.ä¼šè¯

        ç»“æœ = await bag_services.è´­ä¹°å•†å“æ–¹æ³•(
            ä¼šè¯=ä¼šè¯,
            è¾“å…¥åç§°=åç§°,
            æ•°é‡=æ•°é‡
        )

        if ç»“æœ.æ˜¯å¦æˆåŠŸ:
            yield äº‹ä»¶.plain_result(ç»“æœ.æ•°æ®ä¿¡æ¯)
        else:
            yield äº‹ä»¶.plain_result(ç»“æœ.é”™è¯¯ä¿¡æ¯)

    @pm.command("èƒŒåŒ…", alias={"æˆ‘çš„èƒŒåŒ…", "æ‰“å¼€èƒŒåŒ…", "æŸ¥çœ‹ç‰©å“"})
    @æ£€æŸ¥ç”¨æˆ·æ³¨å†ŒçŠ¶æ€
    @ä¼šè¯åˆå§‹åŒ–
    async def æŸ¥çœ‹èƒŒåŒ…æ–¹æ³•(self, äº‹ä»¶: AstrMessageEvent):
        """æŸ¥çœ‹èƒŒåŒ…å›¾ç‰‡"""
        # æŸ¥è¯¢ç”¨æˆ·çš„ç‰©å“
        ä¼šè¯ = äº‹ä»¶.ä¼šè¯
        ç»“æœ = await item_repository.æŸ¥è¯¢ç”¨æˆ·ç‰©å“æ–¹æ³•(ä¼šè¯.ç”¨æˆ·qq)

        if not ç»“æœ.æ˜¯å¦æˆåŠŸ:
            yield äº‹ä»¶.plain_result(ç»“æœ.é”™è¯¯ä¿¡æ¯)
            return

        ç»“æœ = await asyncio.get_running_loop().run_in_executor(
            self.çº¿ç¨‹æ± ,
            image_utils.å›¾ç‰‡ç”Ÿæˆå¤„ç†å™¨,
            image_data_services.ç”ŸæˆèƒŒåŒ…å›¾ç‰‡ä¿¡æ¯æ–¹æ³•,
            ç»“æœ.æ•°æ®ä¿¡æ¯
        )

        if not ç»“æœ.æ˜¯å¦æˆåŠŸ:
            yield äº‹ä»¶.plain_result("æŸ¥çœ‹å¤±è´¥äº†, ä¼¼ä¹æ˜¯å›¾ç‰‡ç”Ÿæˆæ—¶å‡ºé”™äº†")
            return

        yield äº‹ä»¶.chain_result([
            Image.fromBytes(ç»“æœ.æ•°æ®ä¿¡æ¯)
        ])

    async def ä½¿ç”¨ç‰©å“æ–¹æ³•(self, äº‹ä»¶: AstrMessageEvent, ç‰©å“åç§°: str, æ•°é‡æˆ–åºå·: int = 1):
        """
        ä½¿ç”¨èƒŒåŒ…ä¸­çš„é“å…·ã€‚
        """
        ä¼šè¯: ä¼šè¯ç±» = äº‹ä»¶.ä¼šè¯

        if æ•°é‡æˆ–åºå· < 1:
            yield äº‹ä»¶.plain_result("æ•°é‡æˆ–åºå·å¿…é¡»æ˜¯å¤§äº0çš„æ•´æ•°ã€‚")
            return

        ç»“æœ = await item_repository.æ‰§è¡Œä½¿ç”¨ç‰©å“æ–¹æ³•(
            ä¼šè¯=ä¼šè¯,
            ç‰©å“åç§°=ç‰©å“åç§°,
            æ•°é‡æˆ–åºå·=æ•°é‡æˆ–åºå·
        )

        yield äº‹ä»¶.plain_result(ç»“æœ.æ•°æ®ä¿¡æ¯ if ç»“æœ.æ˜¯å¦æˆåŠŸ else ç»“æœ.é”™è¯¯ä¿¡æ¯)

    @pm.command("æ–°å»ºé˜Ÿä¼", alias={"åˆ›å»ºé˜Ÿä¼", "æ–°å»ºé˜Ÿä¼", "é˜Ÿä¼åˆ›å»º", "å»ºç«‹é˜Ÿä¼", "ç”Ÿæˆé˜Ÿä¼"})
    @æ£€æŸ¥ç”¨æˆ·æ³¨å†ŒçŠ¶æ€
    @ä¼šè¯åˆå§‹åŒ–
    async def æ–°å»ºé˜Ÿä¼æ–¹æ³•(self, äº‹ä»¶: AstrMessageEvent, åç§°: str):
        """æ–°å»ºä¸€åªé˜Ÿä¼,éœ€è¦åç§°"""
        ä¼šè¯: ä¼šè¯ç±» = äº‹ä»¶.ä¼šè¯

        ç”¨æˆ·èƒŒåŒ…å¯¹è±¡ = await bag.èƒŒåŒ…ç®¡ç†ç±».create(ä¼šè¯=ä¼šè¯)

        ç»“æœ = await pokemon_services.æ–°å»ºå®å¯æ¢¦é˜Ÿä¼æ–¹æ³•(
            ä¼šè¯=ä¼šè¯,
            é˜Ÿä¼åç§°=åç§°,
            ç”¨æˆ·èƒŒåŒ…å¯¹è±¡=ç”¨æˆ·èƒŒåŒ…å¯¹è±¡,
        )

        if ç»“æœ.æ˜¯å¦æˆåŠŸ:
            yield äº‹ä»¶.plain_result(ç»“æœ.æ•°æ®ä¿¡æ¯)
        else:
            yield äº‹ä»¶.plain_result(ç»“æœ.é”™è¯¯ä¿¡æ¯)

    @pm.command("åˆ é™¤é˜Ÿä¼", alias={"æ¸…ç©ºé˜Ÿä¼", "è§£ä½“é˜Ÿä¼"})
    @æ£€æŸ¥ç”¨æˆ·æ³¨å†ŒçŠ¶æ€
    @ä¼šè¯åˆå§‹åŒ–
    async def åˆ é™¤é˜Ÿä¼æ–¹æ³•(self, äº‹ä»¶: AstrMessageEvent, é˜Ÿä¼åºå·: int):
        """è¾“å…¥é˜Ÿä¼åºå·å³å¯åˆ é™¤é˜Ÿä¼å“¦"""
        ä¼šè¯: ä¼šè¯ç±» = äº‹ä»¶.ä¼šè¯

        async with self.é€šç”¨æ“ä½œç¼“å­˜_é”:
            ç”¨æˆ·ç¼“å­˜å­—å…¸ = self.é€šç”¨æ“ä½œç¼“å­˜.get(ä¼šè¯.ç”¨æˆ·qq, {})
            ç¼“å­˜ä¿¡æ¯ = ç”¨æˆ·ç¼“å­˜å­—å…¸.get(ç¼“å­˜ç±»å‹ç±».åˆ é™¤é˜Ÿä¼, False)

            ç»“æœ = await team_repository.æ‰§è¡Œåˆ é™¤é˜Ÿä¼æ–¹æ³•(
                ä¼šè¯=ä¼šè¯,
                é˜Ÿä¼åºå·=é˜Ÿä¼åºå·,
                ç¼“å­˜ä¿¡æ¯=ç¼“å­˜ä¿¡æ¯
            )

            if ç»“æœ.æ˜¯å¦æˆåŠŸ:
                if ç¼“å­˜ä¿¡æ¯:
                    del self.é€šç”¨æ“ä½œç¼“å­˜[ä¼šè¯.ç”¨æˆ·qq]
                else:
                    ç”¨æˆ·ç¼“å­˜å­—å…¸[ç¼“å­˜ç±»å‹ç±».åˆ é™¤é˜Ÿä¼] = {
                        "åˆ°æœŸæ—¶é—´": time.time() + self.ç¼“å­˜è¶…æ—¶æ—¶é•¿,
                        "æ•°æ®": é˜Ÿä¼åºå·,
                        "äº‹ä»¶": äº‹ä»¶
                    }
                    self.é€šç”¨æ“ä½œç¼“å­˜[ä¼šè¯.ç”¨æˆ·qq] = ç”¨æˆ·ç¼“å­˜å­—å…¸
                    yield äº‹ä»¶.plain_result(
                        f"è¯·æ³¨æ„, è¿™æ˜¯ä¸€ä¸ªå±é™©çš„æ“ä½œ!\nè¯·å†æ¬¡ç¡®å®šæ˜¯å¦è¦åˆ é™¤åºå·:{ç»“æœ.æ•°æ®ä¿¡æ¯[0]}, åç§°ä¸º{ç»“æœ.æ•°æ®ä¿¡æ¯[1]}çš„é˜Ÿä¼!\nè¯·è¾“å…¥ã€Œ/pm åˆ é™¤é˜Ÿä¼ {é˜Ÿä¼åºå·}ã€ æ¥ç¡®å®šåˆ é™¤")
            else:
                yield äº‹ä»¶.plain_result(ç»“æœ.é”™è¯¯ä¿¡æ¯)

    @pm.command("åˆ‡æ¢", alias={"åˆ‡æ¢é˜Ÿä¼", "é˜Ÿä¼åˆ‡æ¢", "ä½¿ç”¨é˜Ÿä¼"})
    @æ£€æŸ¥ç”¨æˆ·æ³¨å†ŒçŠ¶æ€
    @ä¼šè¯åˆå§‹åŒ–
    async def åˆ‡æ¢é˜Ÿä¼æ–¹æ³•(self, äº‹ä»¶: AstrMessageEvent, é˜Ÿä¼åºå·æˆ–åç§°: str):
        """åˆ‡æ¢ç”¨æˆ·çš„é»˜è®¤é˜Ÿä¼"""
        ä¼šè¯: ä¼šè¯ç±» = äº‹ä»¶.ä¼šè¯

        ç»“æœ = await team_repository.æ‰§è¡Œåˆ‡æ¢é˜Ÿä¼æ–¹æ³•(ä¼šè¯, é˜Ÿä¼åºå·æˆ–åç§°)

        yield äº‹ä»¶.plain_result(ç»“æœ.æ•°æ®ä¿¡æ¯ if ç»“æœ.æ˜¯å¦æˆåŠŸ else ç»“æœ.é”™è¯¯ä¿¡æ¯)

    @pm.command("é˜Ÿä¼", alias={"æŸ¥çœ‹é˜Ÿä¼", "æŸ¥è¯¢é˜Ÿä¼", "é˜Ÿä¼æŸ¥çœ‹", "é˜Ÿä¼æŸ¥è¯¢", "æŸ¥çœ‹é˜Ÿä¼ä¿¡æ¯", "é˜Ÿä¼ä¿¡æ¯"})
    @æ£€æŸ¥ç”¨æˆ·æ³¨å†ŒçŠ¶æ€
    @ä¼šè¯åˆå§‹åŒ–
    async def æŸ¥çœ‹é˜Ÿä¼ä¿¡æ¯æ–¹æ³•(self, äº‹ä»¶: AstrMessageEvent):
        """æŸ¥çœ‹æœ¬é˜Ÿçš„å®å¯æ¢¦ä¿¡æ¯"""
        ä¼šè¯: ä¼šè¯ç±» = äº‹ä»¶.ä¼šè¯

        ç»“æœ = await team_repository.æ‰§è¡ŒæŸ¥çœ‹é˜Ÿä¼ä¿¡æ¯æ–¹æ³•(ä¼šè¯=ä¼šè¯)

        if ç»“æœ.æ˜¯å¦æˆåŠŸ:
            é˜Ÿä¼åç§°, é˜Ÿä¼çœŸå®åºå·, é˜Ÿä¼ä¿¡æ¯ = ç»“æœ.æ•°æ®ä¿¡æ¯
        else:
            yield äº‹ä»¶.plain_result(ç»“æœ.é”™è¯¯ä¿¡æ¯)
            return

        ç»“æœ = await asyncio.get_running_loop().run_in_executor(
            self.çº¿ç¨‹æ± ,
            image_utils.å›¾ç‰‡ç”Ÿæˆå¤„ç†å™¨,
            image_data_services.ç”Ÿæˆå®å¯æ¢¦é˜Ÿåˆ—ä¿¡æ¯é…ç½®æ–¹æ³•,
            é˜Ÿä¼ä¿¡æ¯,
            äº‹ä»¶.get_sender_name(),
            é˜Ÿä¼åç§°,
            ä¼šè¯,
            é˜Ÿä¼çœŸå®åºå·
        )

        if not ç»“æœ.æ˜¯å¦æˆåŠŸ:
            yield äº‹ä»¶.plain_result("æŸ¥çœ‹å¤±è´¥äº†, ä¼¼ä¹æ˜¯å›¾ç‰‡ç”Ÿæˆæ—¶å‡ºé”™äº†")
            return

        yield äº‹ä»¶.chain_result([
            Image.fromBytes(ç»“æœ.æ•°æ®ä¿¡æ¯)
        ])

    @pm.command("é˜Ÿä¼åˆ—è¡¨", alias={"æ‰€æœ‰é˜Ÿä¼", "å…¨éƒ¨é˜Ÿä¼", "æŸ¥çœ‹æ‰€æœ‰é˜Ÿä¼", "æŸ¥çœ‹å…¨éƒ¨é˜Ÿä¼"})
    @æ£€æŸ¥ç”¨æˆ·æ³¨å†ŒçŠ¶æ€
    @ä¼šè¯åˆå§‹åŒ–
    async def æŸ¥çœ‹å…¨éƒ¨é˜Ÿä¼ä¿¡æ¯æ–¹æ³•(self, äº‹ä»¶: AstrMessageEvent, é¡µæ•°: int = 1):
        ä¼šè¯: ä¼šè¯ç±» = äº‹ä»¶.ä¼šè¯

        ç»“æœ = await team_services.è·å–å…¨éƒ¨é˜Ÿä¼ä¿¡æ¯æ–¹æ³•(ä¼šè¯, é¡µæ•°)

        if not ç»“æœ.æ˜¯å¦æˆåŠŸ:
            yield äº‹ä»¶.plain_result(str(ç»“æœ.é”™è¯¯ä¿¡æ¯))
            return

        if not ç»“æœ.æ•°æ®ä¿¡æ¯:
            yield äº‹ä»¶.plain_result("è¿˜æ²¡æœ‰é˜Ÿä¼å“¦, ä½¿ç”¨ã€Œ/pm æ–°å»ºé˜Ÿä¼ [é˜Ÿä¼åç§°]ã€æ¥åˆ›å»ºå§")
            return

        ç»“æœ = await asyncio.get_running_loop().run_in_executor(
            self.çº¿ç¨‹æ± ,
            image_utils.å›¾ç‰‡ç”Ÿæˆå¤„ç†å™¨,
            image_data_services.ç”Ÿæˆé˜Ÿä¼åˆ—è¡¨ä¿¡æ¯é…ç½®æ–¹æ³•,
            ä¼šè¯,
            ç»“æœ.æ•°æ®ä¿¡æ¯[0],
            ç»“æœ.æ•°æ®ä¿¡æ¯[1]
        )

        if not ç»“æœ.æ˜¯å¦æˆåŠŸ:
            yield äº‹ä»¶.plain_result("å›¾ç‰‡ä½ç½®ä¿¡æ¯ç”Ÿæˆå¤±è´¥äº†")
            return

        yield äº‹ä»¶.chain_result([
            Image.fromBytes(ç»“æœ.æ•°æ®ä¿¡æ¯)
        ])

    @pm.command("å…¥é˜Ÿ", alias={"é˜Ÿä¼æ·»åŠ å®å¯æ¢¦", "é˜Ÿä¼å¢åŠ ", "é˜Ÿä¼åŠ å…¥", "åŠ å…¥é˜Ÿä¼", "å¦‚å¯¹"})
    @æ£€æŸ¥ç”¨æˆ·æ³¨å†ŒçŠ¶æ€
    @ä¼šè¯åˆå§‹åŒ–
    async def å®å¯æ¢¦åŠ å…¥é˜Ÿä¼æ–¹æ³•(self, äº‹ä»¶: AstrMessageEvent, ç›’å­åºå·: int, é˜Ÿä¼åºå·: int = None):
        """è¯·å…ˆä½¿ç”¨ã€Œ/pm ç›’å­ã€æŸ¥çœ‹å®å¯æ¢¦ç¼–å·, æ ¹æ®ç¼–å·æ¥æ·»åŠ å®å¯æ¢¦è‡³æŒ‡å®šé»˜è®¤é˜Ÿä¼, ä¹Ÿå¯ä»¥æŒ‡å®šé˜Ÿä¼åºå·"""
        ä¼šè¯: ä¼šè¯ç±» = äº‹ä»¶.ä¼šè¯

        ç»“æœ = await team_repository.æ·»åŠ å®å¯æ¢¦å…¥é˜Ÿæ–¹æ³•(
            ä¼šè¯=ä¼šè¯,
            ç›’å­åºå·=ç›’å­åºå·,
            é˜Ÿä¼åºå·=é˜Ÿä¼åºå·
        )

        yield äº‹ä»¶.plain_result(ç»“æœ.æ•°æ®ä¿¡æ¯ if ç»“æœ.æ˜¯å¦æˆåŠŸ else ç»“æœ.é”™è¯¯ä¿¡æ¯)

    @pm.command("ç¦»é˜Ÿ", alias={"è¸¢å‡ºå®å¯æ¢¦", "ç¦»å¼€é˜Ÿä¼", "æé˜Ÿ", "é‡Œé˜Ÿ"})
    @æ£€æŸ¥ç”¨æˆ·æ³¨å†ŒçŠ¶æ€
    @ä¼šè¯åˆå§‹åŒ–
    async def å®å¯æ¢¦ç¦»å¼€é˜Ÿä¼æ–¹æ³•(self, äº‹ä»¶: AstrMessageEvent, ä½ç½®åºå·: int, é˜Ÿä¼åºå·: int = None):
        """å®å¯æ¢¦ç¦»å¼€åè‡ªåŠ¨è¿›å…¥ç›’å­, å¯æŒ‡å®šé˜Ÿä¼"""
        ä¼šè¯: ä¼šè¯ç±» = äº‹ä»¶.ä¼šè¯

        ç»“æœ = await team_repository.æ‰§è¡Œå®å¯æ¢¦ç¦»é˜Ÿæ–¹æ³•(
            ä¼šè¯=ä¼šè¯,
            ä½ç½®åºå·=ä½ç½®åºå·,
            é˜Ÿä¼åºå·=é˜Ÿä¼åºå·
        )

        yield äº‹ä»¶.plain_result(ç»“æœ.æ•°æ®ä¿¡æ¯ if ç»“æœ.æ˜¯å¦æˆåŠŸ else ç»“æœ.é”™è¯¯ä¿¡æ¯)

    @pm.command("ç›’å­", alias={"å®å¯æ¢¦ç›’å­", "æŸ¥çœ‹æ‰€æœ‰å®å¯æ¢¦", "æŸ¥çœ‹ç›’å­"})
    @æ£€æŸ¥ç”¨æˆ·æ³¨å†ŒçŠ¶æ€
    @ä¼šè¯åˆå§‹åŒ–
    async def æŸ¥çœ‹å®å¯æ¢¦ç›’å­æ–¹æ³•(self, äº‹ä»¶: AstrMessageEvent, é¡µæ•°: int = 1):
        """åˆ—å‡ºæœªåŠ å…¥é˜Ÿä¼çš„å®å¯æ¢¦, æ”¯æŒåˆ†é¡µæŸ¥çœ‹"""
        ä¼šè¯: ä¼šè¯ç±» = äº‹ä»¶.ä¼šè¯

        ç»“æœ = await pokemon_repository.æ‰§è¡ŒæŸ¥çœ‹ç›’å­æ–¹æ³•(
            ä¼šè¯=ä¼šè¯,
            é¡µæ•°=é¡µæ•°
        )

        if ç»“æœ.æ˜¯å¦æˆåŠŸ:
            ç›’å­å®å¯æ¢¦ä¿¡æ¯åˆ—è¡¨, æœ€ç»ˆé¡µ, é¡µæ•° = ç»“æœ.æ•°æ®ä¿¡æ¯
        else:
            yield äº‹ä»¶.plain_result(ç»“æœ.é”™è¯¯ä¿¡æ¯)
            return

        ç»“æœ = await asyncio.get_running_loop().run_in_executor(
            self.çº¿ç¨‹æ± ,
            image_utils.å›¾ç‰‡ç”Ÿæˆå¤„ç†å™¨,
            image_data_services.ç”Ÿæˆå®å¯æ¢¦ç›’å­ä¿¡æ¯é…ç½®æ–¹æ³•,
            ç›’å­å®å¯æ¢¦ä¿¡æ¯åˆ—è¡¨,
            ä¼šè¯,
            é¡µæ•°,
            æœ€ç»ˆé¡µ
        )

        if not ç»“æœ.æ˜¯å¦æˆåŠŸ:
            yield äº‹ä»¶.plain_result("æŸ¥çœ‹å¤±è´¥äº†, ä¼¼ä¹æ˜¯å›¾ç‰‡ç”Ÿæˆæ—¶å‡ºé”™äº†")
            return

        yield äº‹ä»¶.chain_result([
            Image.fromBytes(ç»“æœ.æ•°æ®ä¿¡æ¯)
        ])

    @pm.command("å¯¹å†³", alias={"å¯¹æˆ˜", "å†³æ–—", "æ”»å‡»", "è¿›æ”»", "æˆ˜æ–—"})
    @æ£€æŸ¥ç”¨æˆ·æ³¨å†ŒçŠ¶æ€
    @ä¼šè¯åˆå§‹åŒ–
    async def å¯¹æˆ˜æ–¹æ³•(self, äº‹ä»¶: AstrMessageEvent):
        # è¾…åŠ©å‡½æ•°, ç”¨äºçº¿ç¨‹æ± è°ƒç”¨
        def æ‰§è¡Œè¿”å›æˆ˜æ–—å›¾æ–¹æ³•(æ•°æ®, æ¨¡å¼):
            if æ¨¡å¼ == 1:
                return æˆ˜æ–—å¯¹è±¡.è¿”å›æˆ˜æ–—å›¾æ–¹æ³•(
                    èƒŒæ™¯å›¾åç§°,
                    æ•°æ®["æœ¬æ–¹å®å¯æ¢¦å¯¹è±¡"].æå–ç”»æˆ˜æ–—å›¾æ‰€éœ€æ•°æ®(),
                    æ•°æ®["å¯¹æ–¹å®å¯æ¢¦å¯¹è±¡"].æå–ç”»æˆ˜æ–—å›¾æ‰€éœ€æ•°æ®()
                )
            elif æ¨¡å¼ == 2:
                return æˆ˜æ–—å¯¹è±¡.è¿”å›æˆ˜æ–—å›¾æ–¹æ³•(
                    æ•°æ®["èƒŒæ™¯å›¾åç§°"],
                    æ•°æ®["å·¦ä¾§å®å¯æ¢¦æ•°æ®"],
                    æ•°æ®["å³ä¾§å®å¯æ¢¦æ•°æ®"],
                    æ•°æ®["æœ¬æ–¹å¼€å¯mega"],
                    æ•°æ®["æœ¬æ–¹å¼€å¯æå·¨åŒ–"],
                    æ•°æ®["å¯¹æ–¹å¼€å¯mega"],
                    æ•°æ®["å¯¹æ–¹å¼€å¯æå·¨åŒ–"],
                )

        ä¼šè¯: ä¼šè¯ç±» = äº‹ä»¶.ä¼šè¯
        æ¶ˆæ¯åˆ—è¡¨: list = äº‹ä»¶.message_obj.message
        èŠ‚ç‚¹åˆ—è¡¨ = []

        # for i in æ¶ˆæ¯åˆ—è¡¨:
        #     if isinstance(i, At):
        #         æ•Œäººqq: str = int(i.qq)
        #         break
        # else:
        #     yield äº‹ä»¶.plain_result("æ²¡æœ‰æŒ‡å®šæ•Œäººå“¦, éœ€è¦@å¯¹æ–¹, å¹¶ä¸”ä¸è¦å¤åˆ¶@å†…å®¹")
        #     return
        # ! ä¸´æ—¶ä»£ç  ! ç”¨äºå¯¹æˆ˜
        # æ•Œäººqq = 2971074480
        æ•Œäººqq = 3351714298
        # if ä¼šè¯.ç”¨æˆ·qq == æ•Œäººqq:
        #     yield äº‹ä»¶.plain_result("ä¸èƒ½å’Œè‡ªå·±å¯¹æˆ˜å“¦")
        #     return

        ç»“æœ = await battle_services.è¿”å›åŒæ–¹å¯¹æˆ˜ç›¸å…³å¯¹è±¡æ–¹æ³•(ä¼šè¯, æ•Œäººqq)

        if ç»“æœ.æ˜¯å¦æˆåŠŸ:
            å¯¹æˆ˜ç›¸å…³ä¿¡æ¯ = ç»“æœ.æ•°æ®ä¿¡æ¯
        else:
            yield äº‹ä»¶.plain_result(ç»“æœ.é”™è¯¯ä¿¡æ¯)
            return

        # è·å–åŒæ–¹æ˜µç§°
        æœ¬æ–¹æ˜µç§° = äº‹ä»¶.get_sender_name()

        # è¯·æ±‚ = await äº‹ä»¶.bot.api.call_action(
        #     'get_stranger_info', user_id=str(æ•Œäººqq)
        # )

        # å¯¹æ–¹æ˜µç§° = è¯·æ±‚.get("nick", æ•Œäººqq)
        å¯¹æ–¹æ˜µç§° = "æµ‹è¯•æ•Œäºº"

        æˆ˜æ–—å¯¹è±¡ = battle.æˆ˜æ–—ç±»(
            ä¼šè¯=ä¼šè¯,
            æœ¬æ–¹é˜Ÿä¼å®å¯æ¢¦ä¿¡æ¯åˆ—è¡¨=å¯¹æˆ˜ç›¸å…³ä¿¡æ¯["æœ¬æ–¹å®å¯æ¢¦å¯¹è±¡åˆ—è¡¨"],
            å¯¹æ–¹é˜Ÿä¼å®å¯æ¢¦ä¿¡æ¯åˆ—è¡¨=å¯¹æˆ˜ç›¸å…³ä¿¡æ¯["å¯¹æ–¹å®å¯æ¢¦å¯¹è±¡åˆ—è¡¨"],
            æœ¬æ–¹èƒŒåŒ…å¯¹è±¡=å¯¹æˆ˜ç›¸å…³ä¿¡æ¯["æœ¬æ–¹èƒŒåŒ…å¯¹è±¡"],
            å¯¹æ–¹èƒŒåŒ…å¯¹è±¡=å¯¹æˆ˜ç›¸å…³ä¿¡æ¯["å¯¹æ–¹èƒŒåŒ…å¯¹è±¡"],
            æœ¬æ–¹é˜Ÿä¼åç§°=å¯¹æˆ˜ç›¸å…³ä¿¡æ¯["æœ¬æ–¹é˜Ÿä¼åç§°"],
            å¯¹æ–¹é˜Ÿä¼åç§°=å¯¹æˆ˜ç›¸å…³ä¿¡æ¯["å¯¹æ–¹é˜Ÿä¼åç§°"],
            æœ¬æ–¹æ˜µç§°=æœ¬æ–¹æ˜µç§°,
            å¯¹æ–¹æ˜µç§°=å¯¹æ–¹æ˜µç§°,
        )

        èƒŒæ™¯å›¾åç§° = image_data_services.è¿”å›èƒŒæ™¯å›¾åç§°()

        åˆå§‹æˆ˜åœºå›¾èŠ‚ç‚¹ = None
        if ä¼šè¯.æ˜¯å¦ç”Ÿæˆæˆ˜åœºå›¾:
            ç»“æœ = await asyncio.get_running_loop().run_in_executor(
                self.çº¿ç¨‹æ± ,
                æ‰§è¡Œè¿”å›æˆ˜æ–—å›¾æ–¹æ³•,
                {
                    "æœ¬æ–¹å®å¯æ¢¦å¯¹è±¡": å¯¹æˆ˜ç›¸å…³ä¿¡æ¯["æœ¬æ–¹å®å¯æ¢¦å¯¹è±¡åˆ—è¡¨"][0],
                    "å¯¹æ–¹å®å¯æ¢¦å¯¹è±¡": å¯¹æˆ˜ç›¸å…³ä¿¡æ¯["å¯¹æ–¹å®å¯æ¢¦å¯¹è±¡åˆ—è¡¨"][0]
                },
                1
            )

            if ç»“æœ.æ˜¯å¦æˆåŠŸ:
                if ä¼šè¯.æ˜¯å¦ç«‹å³å‘é€ç¬¬ä¸€å¼ æˆ˜åœºå›¾:
                # if True:
                    yield äº‹ä»¶.chain_result([Image.fromBytes(ç»“æœ.æ•°æ®ä¿¡æ¯)])
                else:
                    åˆå§‹æˆ˜åœºå›¾èŠ‚ç‚¹ = Node(
                        uin=ä¼šè¯.æœºå™¨äººqq,
                        name="è§£è¯´å‘˜",
                        content=[Image.fromBytes(ç»“æœ.æ•°æ®ä¿¡æ¯)]
                    )
            else:
                yield äº‹ä»¶.plain_result("å¯¹æˆ˜å¤±è´¥äº†, ä¼¼ä¹æ˜¯å›¾ç‰‡ç”Ÿæˆæ—¶å‡ºé”™äº†")
                return

        # å¼€å§‹å¯¹æˆ˜
        å¯¹æˆ˜è®°å½•åˆ—è¡¨, å¥–åŠ±å­—å…¸ = await æˆ˜æ–—å¯¹è±¡.é˜Ÿä¼å¯¹æˆ˜æ–¹æ³•(èƒŒæ™¯å›¾åç§°)

        # å‘æ”¾æˆ˜æ–—ç»“æŸå¥–åŠ±
        ç»“æœ = await battle_repository.æˆ˜æ–—å¥–åŠ±å‘æ”¾æ–¹æ³•(ä¼šè¯, å½“å‰é˜Ÿä¼ID=å¯¹æˆ˜ç›¸å…³ä¿¡æ¯["æœ¬æ–¹é˜Ÿä¼ID"], å¥–åŠ±å­—å…¸=å¥–åŠ±å­—å…¸)

        if ç»“æœ.æ˜¯å¦æˆåŠŸ:
            print(ç»“æœ.æ•°æ®ä¿¡æ¯)
            å¯¹æˆ˜è®°å½•åˆ—è¡¨.append([("æ–‡æœ¬", "\n".join(ç»“æœ.æ•°æ®ä¿¡æ¯))])
        else:
            print("å¯¹æˆ˜æ‰§è¡Œå¤±è´¥, å¥–åŠ±å‘æ”¾å‡ºé”™: "+ç»“æœ.é”™è¯¯ä¿¡æ¯)
            yield äº‹ä»¶.plain_result("å¯¹æˆ˜æ‰§è¡Œå¤±è´¥, å¥–åŠ±å‘æ”¾å‡ºé”™")
            return

        èŠ‚ç‚¹åˆ—è¡¨ = []

        # å¦‚æœç”Ÿæˆäº†åˆå§‹æˆ˜åœºå›¾ä¸”ä¸ç«‹å³å‘é€ï¼Œåˆ™æ·»åŠ åˆ°èŠ‚ç‚¹åˆ—è¡¨å¼€å¤´
        if åˆå§‹æˆ˜åœºå›¾èŠ‚ç‚¹ is not None:
            èŠ‚ç‚¹åˆ—è¡¨.append(åˆå§‹æˆ˜åœºå›¾èŠ‚ç‚¹)

        for æ¶ˆæ¯å— in å¯¹æˆ˜è®°å½•åˆ—è¡¨:
            æ¶ˆæ¯å—å†…å®¹åˆ—è¡¨ = []
            æ–‡æœ¬ç¼“å­˜ = ""

            for å†…å®¹å…ƒç»„ in æ¶ˆæ¯å—:
                ç±»å‹ = å†…å®¹å…ƒç»„[0]
                æ•°æ® = å†…å®¹å…ƒç»„[1]

                if ç±»å‹ == "æ–‡æœ¬":
                    try:
                        æ–‡æœ¬ç¼“å­˜ += æ•°æ® + "\n"
                    except Exception as e:
                        print(æ•°æ® ,e)
                elif ç±»å‹ == "å›¾ç‰‡":
                    if æ–‡æœ¬ç¼“å­˜:
                        # å°†å›åˆå¼€å§‹åˆ°å›¾ç‰‡ä¹‹å‰çš„æ–‡æœ¬ç¼“å­˜
                        æ¶ˆæ¯å—å†…å®¹åˆ—è¡¨.append(Plain(æ–‡æœ¬ç¼“å­˜))
                        æ–‡æœ¬ç¼“å­˜ = ""

                    ç»“æœ = await asyncio.get_running_loop().run_in_executor(
                        self.çº¿ç¨‹æ± ,
                        æ‰§è¡Œè¿”å›æˆ˜æ–—å›¾æ–¹æ³•,
                        æ•°æ®,
                        2
                    )

                    if ç»“æœ.æ˜¯å¦æˆåŠŸ:
                        æ¶ˆæ¯å—å†…å®¹åˆ—è¡¨.append(Image.fromBytes(ç»“æœ.æ•°æ®ä¿¡æ¯))
                    else:
                        print("é”™è¯¯ æå·¨åŒ–æˆ–megaçš„æˆ˜æ–—å›¾ç”Ÿäº§å¤±è´¥: " + ç»“æœ.é”™è¯¯ä¿¡æ¯)
                        yield äº‹ä»¶.plain_result("å¯¹æˆ˜å¤±è´¥äº†, ä¼¼ä¹æ˜¯å›¾ç‰‡ç”Ÿæˆæ—¶å‡ºé”™äº†")
                        return

            if æ–‡æœ¬ç¼“å­˜:
                æ¶ˆæ¯å—å†…å®¹åˆ—è¡¨.append(Plain(æ–‡æœ¬ç¼“å­˜.rstrip('\n')))

            if æ¶ˆæ¯å—å†…å®¹åˆ—è¡¨:
                yield äº‹ä»¶.chain_result(æ¶ˆæ¯å—å†…å®¹åˆ—è¡¨)
                # èŠ‚ç‚¹åˆ—è¡¨.append(Node(
                #     uin=ä¼šè¯.æœºå™¨äººqq,
                #     name="è§£è¯´å‘˜",
                #     content=æ¶ˆæ¯å—å†…å®¹åˆ—è¡¨
                # ))

        # if èŠ‚ç‚¹åˆ—è¡¨:
        #     yield äº‹ä»¶.chain_result([Nodes(nodes=èŠ‚ç‚¹åˆ—è¡¨)])